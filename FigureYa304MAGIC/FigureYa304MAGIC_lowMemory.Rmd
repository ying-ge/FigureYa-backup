---
title: "FigureYa304MAGIC (low memory solution)"
params:
  author: "Jianing Gao; Yasi Zhang"  
  reviewer: "Ying Ge"
output: html_document
---

**Author(s)**: `r params$author`  
**Reviewer(s)**: `r params$reviewer`  
**Date**: `r Sys.Date()` 

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

运行FigureYa304MAGIC.rmd文档的“MAGIC-knnDREMI”可能遇到内存不足的问题。这里通过Feather格式提高硬盘IO效率，通过切分大矩阵的方式减小内存使用。峰值内存占用大约12G，能得到与“FigureYa304MAGIC.rmd”相似的结果。

# 环境设置


```{r}
# Use system() function to execute commands one by one
cat("Installing MAGIC...\n")

# Clone repository
system("git clone https://github.com/KrishnaswamyLab/MAGIC", timeout = 300)

# Install Python part
setwd("MAGIC/python")
system("python setup.py install --user", timeout = 300)

# Install R part
setwd("../Rmagic")
system("R CMD INSTALL .", timeout = 300)

# Return to original directory
setwd("../../")

# Install python-libmagic
system("pip install python-libmagic", timeout = 300)

cat("MAGIC installation completed!\n")
```

```{r}
source("install_dependencies.R")

# 加载 Seurat 和 SeuratDisk 用于数据转换
library(SeuratDisk)
library(Seurat)
library(tidyverse)
library(ComplexHeatmap)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

# 输入文件

作者已将例文的数据上传至<https://data.humantumoratlas.org/>。

```{r}
# 1. 下载 H5AD 文件
h5ad_url <- "https://datasets.cellxgene.cziscience.com/79f80e59-97e7-4f95-b1e9-9767a24b85b0.h5ad"
h5ad_file <- "SCLC_epithelial_cells.h5ad"

# 检查文件是否已下载，如果未下载则执行下载
if (!file.exists(h5ad_file)) {
  download.file(h5ad_url, destfile = h5ad_file, mode = "wb")
}

# 2. 将 .h5ad 转换为 .h5seurat 格式
h5seurat_file <- "SCLC_epithelial_cells.h5seurat"
Convert(h5ad_file, dest = h5seurat_file, overwrite = TRUE)

# 3. 将 .h5seurat 文件加载为 Seurat 对象
seu <- LoadH5Seurat(h5seurat_file)

# 查看加载后的 Seurat 对象
print(seu)

# 创建临时目录并保存元数据 (与原流程保持一致)
dir.create("tmp.data", showWarnings = FALSE)
saveRDS(seu@meta.data, "tmp.data/SCLC_epithelial_cells.cellmeta.rds")
head(readRDS("tmp.data/SCLC_epithelial_cells.cellmeta.rds"))
```

```{r}
ensembl <- useEnsembl(biomart = "ENSEMBL_MART_ENSEMBL", version = 98)
hg38.ens <- useDataset(dataset = "hsapiens_gene_ensembl", mart = ensembl, verbose = 98)

results <- getBM(attributes = c('ensembl_gene_id', "external_gene_name", 'gene_biotype', 'chromosome_name'),
                 filters = 'ensembl_gene_id',
                 values = rownames(seu), 
                 mart = hg38.ens)

results$uniq.name <- ifelse(duplicated(results$external_gene_name), 
                            paste(results$ensembl_gene_id, results$external_gene_name, sep = "-"),
                            results$external_gene_name)
rownames(results) <- results$ensembl_gene_id
results <- results[rownames(seu), ]

saveRDS(results, "data/gene.info.rds")
```

```{r}
results <- readRDS("data/gene.info.rds")
all(results$ensembl_gene_id == rownames(seu)) # should be TRUE

counts <- seu[["RNA"]]@counts
rownames(counts) <- results$uniq.name

# !important: the unexpressed genes should be removed.
expr.in.cells <- Matrix::rowSums(counts > 0)
summary(expr.in.cells)
selected.genes <- expr.in.cells > 500 # only genes expressed > 500 cells were kept.
table(selected.genes)
counts <- counts[selected.genes, ]

seu <- CreateSeuratObject(counts, meta.data = seu@meta.data)
rm("counts")
gc()
```

# MAGIC-knnDREMI

> 我们通过Feather格式提高硬盘IO效率，通过切分大矩阵的方式减小内存使用

```{r}
# 按数据批次进行任务分割
seu.list <- SplitObject(seu, split.by = "batch")
rm("seu")
gc()

# MAGIC Imputation
source("R/low_memory_utils.R")
MagicImpute_LowMemory(seu.list, tmp.dir = "tmp.data2/magic", knn = 30, t = 3, npca = 56, n.jobs = 4)
rm(list=ls())
gc()

# Calculate DREMI scores
source("R/low_memory_utils.R")
# split tasks
SplitBucketsByFeatures(data.dir = "tmp.data2/magic/", target.dir = "tmp.data2/dremi", n.buckets = 20) # 将矩阵按照基因分割为20个子矩阵
gc()
# calculation
# test: PLCG2 & MTRNR2L12
source("R/magic_utils.R")
source("R/low_memory_utils.R")
dremi.res.1 <- CalculateKnnDREMI_LowMemory(data.dir = "tmp.data2/dremi/", 
                                           source.gene = "PLCG2", 
                                           target.genes = c("MTRNR2L12", "EXD3"), 
                                           return.drevi = T,
                                           n.cores = 1)
DREVIPlot(dremi.res.1$drevi$MTRNR2L12, bins = 20) + labs(x = "PLCG2", y = "MTRNR2L12")

# run: all genes
dremi.res <- CalculateKnnDREMI_LowMemory(data.dir = "tmp.data2/dremi/", 
                                         source.gene = "PLCG2", 
                                         target.genes = NULL, 
                                         return.drevi = F,
                                         n.cores = 10)
write.table(dremi.res$dremi, "tmp.data2/PLCG2.DREMI.tsv", row.names = F, sep = "\t", quote = F)
```

# Compare with the original codes in FigureYa304MAGIC.Rmd

```{r eval=FALSE}
# 加载FigureYa304MAGIC.Rmd生成的PLCG2.DREMI.tsv
dremi.ori <- read.table("tmp.data/PLCG2.DREMI.tsv", sep = "\t", header = T)
# 加载本文档生成的PLCG2.DREMI.tsv
dremi.lm <- read.table("tmp.data2/PLCG2.DREMI.tsv", sep = "\t", header = T)

data.plot <- left_join(dremi.ori, dremi.lm, by = "gene_name")
colnames(data.plot) <- c("gene_name", "dremi_score.ori", "dremi_score.lm")

ggplot(data.plot, aes(dremi_score.ori, dremi_score.lm)) + 
  geom_point(size = .2, alpha = .2) + 
  labs(x = "Original DREMI", y = "Low memory DREMI") + 
  coord_equal() + 
  theme_bw(base_size = 15)
```
